FROM node:22-alpine

# Install tools needed by CMD/healthcheck
RUN apk add --no-cache dumb-init curl

# Use pnpm
RUN npm install -g pnpm@10.13.1

WORKDIR /usr/src/app

# Install dependencies
COPY package.json pnpm-lock.yaml ./
RUN pnpm install --frozen-lockfile

# Copy source and build
COPY . .
RUN pnpm build

# Keep only production deps
RUN pnpm prune --prod

# Quick build verification
RUN echo "Verifying copied files:" && ls -la dist

# App port
ENV PORT=4001
EXPOSE 4001

# Healthcheck (adjust the path if your app uses a different health endpoint)
HEALTHCHECK --interval=10s --timeout=5s --retries=3 \
  CMD curl --fail http://localhost:${PORT}/health || exit 1

# Start app
CMD ["dumb-init", "node", "dist/app.js"]